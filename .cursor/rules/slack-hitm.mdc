---
description: Slack HITM workflow patterns and interactive components with enhanced reliability
globs: apps/slack-bot/**/*.ts, api/slack/**/*.ts
alwaysApply: false
---

# Slack HITM (Human-in-the-Middle) Patterns

## Performance Constraints

⚠️ **Critical:** Slack webhooks timeout at 3 seconds

✅ **DO:** Acknowledge immediately, process async
```typescript
app.action("approve", async ({ ack, body, client }) => {
  await ack(); // ✅ Acknowledge first (<3s)
  
  // Then process async
  await processApproval(body);
});
```

❌ **DON'T:** Process before acknowledging
```typescript
app.action("approve", async ({ ack, body }) => {
  await processApproval(body); // ❌ May timeout
  await ack();
});
```

## Enhanced Reliability Patterns (2025)

✅ **DO:** Use Vercel waitUntil for background tasks
```typescript
import { waitUntil } from "@vercel/functions";

// Fire and forget with proper Vercel handling
const slackTask = postReview(slackPayload).catch((error: unknown) => {
  log("error", "Slack posting failed", { error: parseErrorMessage(error) });
});

if (typeof waitUntil === "function") {
  waitUntil(slackTask);
} else {
  void slackTask; // Non-Vercel environments
}
```

✅ **DO:** Implement Slack connectivity health checks
```typescript
async function testSlackConnectivity(token: string): Promise<SlackHealthCheck> {
  const startTime = Date.now();
  
  try {
    const controller = new AbortController();
    const timeout = setTimeout(() => controller.abort(), 5000);
    
    const res = await fetch("https://slack.com/api/auth.test", {
      method: "POST",
      headers: {
        "Authorization": `Bearer ${token}`,
        "Content-Type": "application/json"
      },
      signal: controller.signal
    });
    
    clearTimeout(timeout);
    const responseTime = Date.now() - startTime;
    const result = await res.json();
    
    return {
      reachable: result.ok === true,
      responseTime,
      statusCode: res.status,
      timestamp: Date.now(),
      error: result.ok ? undefined : result.error
    };
  } catch (error: any) {
    return {
      reachable: false,
      responseTime: Date.now() - startTime,
      timestamp: Date.now(),
      error: error?.message || String(error)
    };
  }
}
```

✅ **DO:** Implement retry queue for failed Slack posts
```typescript
interface SlackRetryItem {
  ticketId: string;
  draftId: string;
  channel: string;
  originalEmail: string;
  draftText: string;
  confidence: number;
  extraction: Record<string, any>;
  retryCount: number;
  nextRetryAt: number;
  createdAt: number;
}

async function queueSlackRetry(params: PostReviewParams): Promise<void> {
  const retryItem: SlackRetryItem = {
    ...params,
    retryCount: 0,
    nextRetryAt: Date.now() + 5 * 60 * 1000, // 5 minutes
    createdAt: Date.now()
  };
  
  slackRetryQueue.push(retryItem);
}
```

## Interactive Components

### Buttons with Metadata

Store context in button values as JSON:

```typescript
{
  type: "button",
  action_id: "approve",
  value: JSON.stringify({ ticketId, draftId, draftText })
}
```

### Modals for Edits

Use modals for complex edits with `private_metadata`:

```typescript
await client.views.open({
  trigger_id: body.trigger_id,
  view: {
    type: "modal",
    callback_id: "edit_modal",
    private_metadata: JSON.stringify({ ticketId, draftId, channelId, messageTs }),
    blocks: [/* ... */]
  }
});
```

🚨 **When opening from a message button:**

- Call `views.open` synchronously and only acknowledge *after* the API responds so the trigger stays valid.
- Do **not** `ack()` or `respond({ ok: true })` before awaiting `views.open`; Slack will silently drop the modal if the request finishes early.
- Still keep total runtime < 3 s – the API call should complete fast enough when done immediately.

## Human Review Storage

Always log decisions to database:

```typescript
await createHumanReview({
  ticketId,
  draftId,
  decision: "approve" | "edit" | "reject",
  finalText: draftText,
  reviewerSlackId: userId
});
```

## Message Formatting

✅ **DO:** Use blocks for rich formatting
```typescript
blocks: [
  {
    type: "section",
    text: {
      type: "mrkdwn",
      text: `*Confidence:* ${(confidence * 100).toFixed(0)}%`
    }
  }
]
```

## Error Handling

Always handle Slack API errors:

```typescript
try {
  await client.chat.postMessage({/* ... */});
} catch (error) {
  console.error("Slack API error:", error);
  // Fallback or retry logic
}
```

## References

- @apps/slack-bot/src/index.ts - HITM implementation
- @packages/db/src/repositories.ts - Human review storage
- @documentation/project/policies.md - Review policies
