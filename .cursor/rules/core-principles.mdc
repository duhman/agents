---
description: Core principles for the agents project (privacy, compliance, schema-driven)
globs:
alwaysApply: true
---

# Core Principles

This project automates customer email responses using **hybrid deterministic/AI processing** with Slack HITM.

## 1. Privacy First

- Mask PII (emails/phones/addresses) before any LLM calls
- Use env variables for secrets; never hardcode tokens
- Store masked versions in database
- Never log raw customer data
- Always use `maskPII()` from `@agents/core` before LLM calls

## 2. Policy Compliance

- Norwegian default; English fallback; Swedish support
- End-of-month cancellation policy
- Encourage app self-service
- Be polite, concise, branded

## 3. Schema-Driven Development

- Use Zod schemas for validation
- OpenAI structured outputs with `zodResponseFormat()`
- Always use `.nullable()` with `.optional()` for optional fields
- Validate all inputs/outputs with `safeParse`

## 4. Hybrid Architecture

- **Deterministic first**: Pattern matching for standard cases (fast, free)
- **AI fallback**: OpenAI for complex/ambiguous cases (accurate, costs API)
- **Metrics collection**: Track processing methods and performance
- **Edge case detection**: Handle special scenarios (corporate accounts, future dates)

## 5. Data Flow

- tickets → drafts → human_reviews
- Store provenance and decisions
- Export approved pairs for fine-tuning
- Minimum 500 examples before fine-tuning

## 6. Code Quality

- TypeScript strict mode
- Prefer explicit types over `any`
- Handle errors gracefully with retry logic
- Structured logging with request IDs for observability
- Request validation middleware for webhooks
- Exponential backoff for API failures

## Key Files

- `@documentation/project/prd.md` - Requirements & KPIs
- `@documentation/project/policies.md` - Tone/policy
- `@documentation/project/prompts.md` - Prompt templates
- `@packages/prompts/src/templates.ts` - Enhanced extraction schemas + drafting
- `@packages/core/src/index.ts` - PII masking
- `@packages/db/src/schema.ts` - Database schema
- `@apps/agent/src/hybrid-processor.ts` - Main hybrid processor
- `@apps/agent/src/simplified-processor.ts` - Pure deterministic processor
- `@apps/agent/src/metrics.ts` - Performance metrics collection
